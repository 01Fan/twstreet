"use strict";function createImage(e,a,t,i,r,n){var g=new Image;g.src="images/object/"+e+".png";var o=new Image;o.src=a;var s=document.getElementById("result");s.width=500,s.height=500;var d=s.getContext("2d");d.rect(0,0,500,500),d.fillStyle="#CCCCCC",d.fill(),d.drawImage(o,t,i,r,n),d.drawImage(g,0,0,500,500);var c=s.toDataURL("image/png");if(window.navigator.userAgent.indexOf("MSIE ")>0||navigator.userAgent.match(/Trident.*rv\:11\./)){var u="<p>請按右鍵另存圖片</p>";u+="<img src='"+c+"' alt='10'/>",window.open().document.write(u)}else $("#download").attr("href",c),$("#download").attr("download",+new Date+".png"),$("#download")[0].click()}function handleFileSelect(e){e.stopPropagation(),e.preventDefault(),loadImage(e.dataTransfer.files)}function handleDragOver(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}function loadImage(e){function a(){(n=new Image).onload=t,n.src=r.result}function t(){var e=document.getElementById("canvas");e.width=n.width,e.height=n.height;var a=e.getContext("2d");a.drawImage(n,0,0);var t=e.toDataURL("image/png");$("#source").attr("value",t),$userimage.css("background-image","url("+t+")");var i,r,g=document.getElementById("thumb");n.width>n.height?(r=100,i=n.width/n.height*100):(i=100,r=n.height/n.width*100),g.width=i,g.height=r,(a=g.getContext("2d")).drawImage(n,0,0,i,r);var o=g.toDataURL("image/png");$("#templates label").css("background-image","url("+o+")"),$("<img/>").attr("src",t).load(function(){var e=$("input[name=template]:checked").val(),a=$userimage.width();resizeDragger([this.width,this.height],a,e),$loading.hide(),$uploading.fadeOut()})}var i,r,n;e?($uploading.fadeIn(),$loading.show(),i=e[0],(r=new FileReader).onload=a,r.readAsDataURL(i)):alert("悲劇！您的瀏覽器不支援檔案上傳！")}function getImgSize(e){var a=new Image;return a.src=e,[a.width,a.height]}function getBackgroundImage(e){return e.css("background-image").replace(/^url\(["']?/,"").replace(/["']?\)$/,"")}function resizeDragger(e,a,t,i){t=void 0!==t?t:1,i=void 0!==i?i:0;var r,n,g,o,s;e[0]>e[1]?(r=a/e[1],g=a,o=0,s=.5*((n=e[0]*r)-a)*-1):(r=a/e[0],n=a,o=.5*((g=e[1]*r)-a)*-1,s=0),6==t?(s=.2*a*-1,e[0]>e[1]&&(s-=.5*(n-a))):9==t?($sizer.slider("value",65),e[0],e[1],s=.65*a*.13*.5,n*=.65,o=.48*(a-(g*=.65))):10==t&&($sizer.slider("value",92),e[0]>e[1]?(g=(n=.92*a)*(e[1]/e[0]),o=.045*a,s=.5*(a-n)):(g*=.92,o=.045*a,s=.5*(a-(n*=.92)))),$dragger.css("width",n+"px").css("height",g+"px").css("top",o+"px").css("left",s+"px"),$userimage.css("background-size",n+"px "+g+"px").css("background-position",s+"px "+o+"px")}function getBackgroundSize(e){return size=e.split(" "),[px2int(size[0]),px2int(size[1])]}function getBackgroundPosition(e){return position=e.split(" "),[px2int(position[0]),px2int(position[1])]}function getBackgroundCenterPoint(e,a){return[.5*e[0]+a[0],.5*e[1]+a[1]]}function px2int(e){return parseFloat(e.replace("px",""))}var $userimage=$("#userimage .inner"),$coverimage=$("#coverimage .inner"),$dragger=$("#dragger"),$sizer=$("#size-slider"),$loading=$("#loading");$uploading=$("#uploading"),$(window).load(function(){var e=$userimage.width();resizeDragger(getImgSize(getBackgroundImage($userimage)),e)}),$(document).ready(function(){$("body").iealert({support:"ie9",title:"您的瀏覽器太舊啦！",text:"請更新您的瀏覽器，我們推薦您使用 Google Chrome",closeBtn:!1,upgradeTitle:"下載 Google Chrome",upgradeLink:"http://www.google.com/chrome/"}),$dragger.draggable({drag:function(e){$userimage.css("background-position",$dragger.css("left")+" "+$dragger.css("top")),0==$userimage.hasClass("dragged")&&$userimage.addClass("dragged");var a=$("input[name=template]:checked").val();9!=a&&10!=a||$userimage.attr("class","inner")}}),$sizer.slider({value:100,max:170,min:30,slide:function(e,a){var t=getBackgroundCenterPoint(getBackgroundSize($userimage.css("background-size")),getBackgroundPosition($userimage.css("background-position")));$("<img/>").attr("src",getBackgroundImage($userimage)).load(function(){var e=[this.width,this.height],i=e[0]*a.value/100,r=e[1]*a.value/100,n=t[0]-.5*i,g=t[1]-.5*r;$dragger.css("width",i+"px").css("height",r+"px").css("top",g+"px").css("left",n+"px"),$userimage.css("background-size",i+"px "+r+"px").css("background-position",n+"px "+g+"px")})}}),$("body").delegate("input[name=template]","change",function(){var e=$(this).val(),a="images/object/"+e+".png";$coverimage.css("background-image","url("+a+")"),1==$userimage.hasClass("dragged")?$userimage.attr("class","inner dragged"):$userimage.attr("class","inner"),$("<img/>").attr("src",getBackgroundImage($userimage)).load(function(){resizeDragger([this.width,this.height],$userimage.width(),e)})}),$("#normalSubmit").click(function(){var e=$userimage.width(),a=getBackgroundSize($userimage.css("background-size")),t=getBackgroundPosition($userimage.css("background-position")),i=e/500,r=$("input[name=template]:checked").val(),n=$("#source").val(),g=a[0]/i,o=a[1]/i;createImage(r,n,t[0]/i,t[1]/i,g,o)})}),$(function(){var e=document.getElementById("drop");e.addEventListener("dragover",handleDragOver,!1),e.addEventListener("drop",handleFileSelect,!1),$(".uploadBtn").click(function(){$("#uploadInput").click()}),$("#uploadInput").on("change",function(){input=document.getElementById("uploadInput"),loadImage(input.files)})});