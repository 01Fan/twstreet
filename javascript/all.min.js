var $userimage=$("#userimage .inner"),$coverimage=$("#coverimage .inner"),$dragger=$("#dragger"),$sizer=$("#size-slider"),$loading=$("#loading");$uploading=$("#uploading");$(window).load(function(){var a=$userimage.width(),b=getImgSize(getBackgroundImage($userimage));resizeDragger(b,a)});
$(document).ready(function(){$dragger.draggable({drag:function(a){$userimage.css("background-position",$dragger.css("left")+" "+$dragger.css("top"));0==$userimage.hasClass("dragged")&&$userimage.addClass("dragged");a=$("input[name=template]:checked").val();9!=a&&10!=a||$userimage.attr("class","inner")}});$sizer.slider({value:100,max:170,min:30,slide:function(a,b){var e=getBackgroundSize($userimage.css("background-size")),c=getBackgroundPosition($userimage.css("background-position")),d=getBackgroundCenterPoint(e,
c);$("<img/>").attr("src",getBackgroundImage($userimage)).load(function(){var a=[this.width,this.height],c=a[0]*b.value/100,a=a[1]*b.value/100,e=d[0]-.5*c,k=d[1]-.5*a;$dragger.css("width",c+"px").css("height",a+"px").css("top",k+"px").css("left",e+"px");$userimage.css("background-size",c+"px "+a+"px").css("background-position",e+"px "+k+"px")})}});$("body").delegate("input[name=template]","change",function(){var a=$(this).val();$coverimage.css("background-image","url("+("images/object/"+a+".png")+
")");1==$userimage.hasClass("dragged")?$userimage.attr("class","inner dragged"):$userimage.attr("class","inner");$("<img/>").attr("src",getBackgroundImage($userimage)).load(function(){var b=[this.width,this.height],e=$userimage.width();resizeDragger(b,e,a)})});$("#normalSubmit").click(function(){$("#plzlike").fadeIn(800);var a=$userimage.width(),b=getBackgroundSize($userimage.css("background-size")),e=getBackgroundPosition($userimage.css("background-position")),a=a/500,c=$("input[name=template]:checked").val(),
d=$("#source").val();createImage(c,d,e[0]/a,e[1]/a,b[0]/a,b[1]/a)})});function createImage(a,b,e,c,d,g){var f=new Image;f.src="images/object/"+a+".png";a=new Image;a.src=b;b=document.getElementById("result");b.width=500;b.height=500;var h=b.getContext("2d");h.rect(0,0,500,500);h.fillStyle="#CCCCCC";h.fill();h.drawImage(a,e,c,d,g);h.drawImage(f,0,0,500,500);e=b.toDataURL("image/png");$("#download").attr("href",e);$("#download")[0].click()}var w=$(window).width();
$(window).resize(function(){var a=$(window).width();if(w!==a){var b=$("input[name=template]:checked").val(),e=$userimage.width(),c=getImgSize(getBackgroundImage($userimage));resizeDragger(c,e,b);w=a}});$(function(){var a=document.getElementById("drop");a.addEventListener("dragover",handleDragOver,!1);a.addEventListener("drop",handleFileSelect,!1);$(".uploadBtn").click(function(){$("#uploadInput").click()});$("#uploadInput").on("change",function(){input=document.getElementById("uploadInput");loadImage(input.files)})});
function handleFileSelect(a){a.stopPropagation();a.preventDefault();loadImage(a.dataTransfer.files)}function handleDragOver(a){a.stopPropagation();a.preventDefault();a.dataTransfer.dropEffect="copy"}$(window).scroll(function(a){a=$(window).scrollTop();var b=$(window).height();a>b?$(".gototop").show():$(".gototop").hide()});$(".gototop").click(function(){$("html,body").animate({scrollTop:0},"fast")});
function loadImage(a){function b(){d=new Image;d.onload=e;d.src=c.result}function e(){var a=document.getElementById("canvas");a.width=d.width;a.height=d.height;a.getContext("2d").drawImage(d,0,0);a=a.toDataURL("image/png");$("#source").attr("value",a);$userimage.css("background-image","url("+a+")");$("#templates label").css("background-image","url("+a+")");$("<img/>").attr("src",a).load(function(){var a=$("input[name=template]:checked").val(),b=$userimage.width();resizeDragger([this.width,this.height],
b,a);$loading.hide();$uploading.fadeOut()})}$uploading.fadeIn();$loading.show();var c,d;a?(a=a[0],c=new FileReader,c.onload=b,c.readAsDataURL(a)):alert("\u60b2\u5287\uff01\u60a8\u7684\u700f\u89bd\u5668\u4e0d\u652f\u63f4\u6a94\u6848\u4e0a\u50b3\uff01")}function getImgSize(a){var b=new Image;b.src=a;return[b.width,b.height]}function getBackgroundImage(a){return a.css("background-image").replace(/^url\(["']?/,"").replace(/["']?\)$/,"")}
function resizeDragger(a,b,e,c){e="undefined"!==typeof e?e:1;var d,g,f;a[0]>a[1]?(d=b/a[1],c=a[0]*d,d=b,g=0,f=-.5*(c-b)):(d=b/a[0],c=b,d*=a[1],g=-.5*(d-b),f=0);6==e?(f=-.2*b,a[0]>a[1]&&(f-=.5*(c-b))):9==e?($sizer.slider("value",65),f=.04225*b,c*=.65,d*=.65,g=.48*(b-d)):10==e&&($sizer.slider("value",92),a[0]>a[1]?(c=.92*b,d=a[1]/a[0]*c):(c*=.92,d*=.92),g=.045*b,f=.5*(b-c));$dragger.css("width",c+"px").css("height",d+"px").css("top",g+"px").css("left",f+"px");$userimage.css("background-size",c+"px "+
d+"px").css("background-position",f+"px "+g+"px")}function getBackgroundSize(a){size=a.split(" ");return[px2int(size[0]),px2int(size[1])]}function getBackgroundPosition(a){position=a.split(" ");return[px2int(position[0]),px2int(position[1])]}function getBackgroundCenterPoint(a,b){return[.5*a[0]+b[0],.5*a[1]+b[1]]}function px2int(a){return parseFloat(a.replace("px",""))};
